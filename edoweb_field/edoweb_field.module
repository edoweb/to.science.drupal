<?php
/**
 * Copyright 2013 hbz NRW (http://www.hbz-nrw.de/)
 *
 * This file is part of regal-drupal.
 *
 * regal-drupal is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * regal-drupal is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with regal-drupal.  If not, see <http://www.gnu.org/licenses/>.
 */

/**
 * Implements hook_field_info().
 */
function edoweb_field_field_info() {
  return array(
    'edoweb_ld_reference' => array(
      'label' => t('A linked data field'),
      'description' => t('This field holds the URI of a linked data resource'),
      'default_widget' => 'edoweb_autocomplete_widget',
      'default_formatter' => 'edoweb_ld_format',
      'property_type' => 'text',
    ),
    'edoweb_date' => array(
      'label' => t('A field for dates'),
      'description' => t('This field holds dates of the format DD.MM.YYYY, MM/YYYY or YYYY'),
      'settings' => array('max_length' => 10),
      'instance_settings' => array('text_processing' => 0),
      'default_widget' => 'text_textfield',
      'default_formatter' => 'text_default',
      'property_type' => 'text',
    ),
    'edoweb_datastream' => array(
      'label' => t('A field for datastreams'),
      'description' => t('This field holds datastream URIs'),
      'instance_settings' => array('text_processing' => 0),
      'default_widget' => 'edoweb_upload_widget',
      'default_formatter' => 'edoweb_datastream_format',
      'property_type' => 'text',
    ),
  );
}

/**
 * Implements hook_field_validate().
 */
function edoweb_field_field_validate($entity_type, $entity, $field, $instance, $langcode, $items, &$errors) {
  // Overwrite default autocomplete behaviour
  drupal_add_js(
    drupal_get_path('module', 'edoweb_field') . '/edoweb_field_autocomplete.js',
    array('weight' => '100')
  );

  switch ($field['type']) {
    case 'edoweb_date':
      foreach ($items as $delta => $item) {
        if (!edoweb_field_field_is_empty($item, $field) &&
            !_edoweb_value_is_valid_date($item['value'])) {
          $errors[$field['field_name']][$langcode][$delta][] = array(
            'error' => 'edoweb_field_date_invalid',
            'message' => t('Dates must be of the form DD.MM.YYY, MM/YYYY or YYYY.'),
          );
        }
      }
      break;
    case 'edoweb_ld_reference':
      foreach ($items as $delta => $item) {
        if (!edoweb_field_field_is_empty($item, $field) &&
            !_edoweb_value_is_valid_uri($item['value'])) {
          $errors[$field['field_name']][$langcode][$delta][] = array(
            'error' => 'edoweb_field_uri_invalid',
            'message' => t('Value must be a valid, absolute URI.'),
          );
        }
      }
      break;
  }
}

function _edoweb_value_is_valid_date($value) {
  $pattern = '/^(\d\d\.\d\d\.\d\d\d\d|\d\d\/\d\d\d\d|\d\d\d\d)$/';
  return preg_match($pattern, $value) === 1;
}

function _edoweb_value_is_valid_uri($value) {
  /*
   * URI validation regular expression from
   * http://jmrware.com/articles/2009/uri_regexp/URI_regex.html#uri-38
   */
  $pattern = "`
    [A-Za-z][A-Za-z0-9+\-.]* :
    (?: //
      (?: (?:[A-Za-z0-9\-._~!$&'()*+,;=:]|%[0-9A-Fa-f]{2})* @)?
      (?:
        \[
        (?:
          (?:
            (?:                                                    (?:[0-9A-Fa-f]{1,4}:){6}
            |                                                   :: (?:[0-9A-Fa-f]{1,4}:){5}
            | (?:                            [0-9A-Fa-f]{1,4})? :: (?:[0-9A-Fa-f]{1,4}:){4}
            | (?: (?:[0-9A-Fa-f]{1,4}:){0,1} [0-9A-Fa-f]{1,4})? :: (?:[0-9A-Fa-f]{1,4}:){3}
            | (?: (?:[0-9A-Fa-f]{1,4}:){0,2} [0-9A-Fa-f]{1,4})? :: (?:[0-9A-Fa-f]{1,4}:){2}
            | (?: (?:[0-9A-Fa-f]{1,4}:){0,3} [0-9A-Fa-f]{1,4})? ::    [0-9A-Fa-f]{1,4}:
            | (?: (?:[0-9A-Fa-f]{1,4}:){0,4} [0-9A-Fa-f]{1,4})? ::
            ) (?:
                [0-9A-Fa-f]{1,4} : [0-9A-Fa-f]{1,4}
              | (?: (?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?) \.){3}
                    (?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)
              )
          |   (?: (?:[0-9A-Fa-f]{1,4}:){0,5} [0-9A-Fa-f]{1,4})? ::    [0-9A-Fa-f]{1,4}
          |   (?: (?:[0-9A-Fa-f]{1,4}:){0,6} [0-9A-Fa-f]{1,4})? ::
          )
        | [Vv][0-9A-Fa-f]+\.[A-Za-z0-9\-._~!$&'()*+,;=:]+
        )
        \]
      | (?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}
           (?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)
      | (?:[A-Za-z0-9\-._~!$&'()*+,;=]|%[0-9A-Fa-f]{2})*
      )
      (?: : [0-9]* )?
      (?:/ (?:[A-Za-z0-9\-._~!$&'()*+,;=:@]|%[0-9A-Fa-f]{2})* )*
    | /
      (?:    (?:[A-Za-z0-9\-._~!$&'()*+,;=:@]|%[0-9A-Fa-f]{2})+
        (?:/ (?:[A-Za-z0-9\-._~!$&'()*+,;=:@]|%[0-9A-Fa-f]{2})* )*
      )?
    |        (?:[A-Za-z0-9\-._~!$&'()*+,;=:@]|%[0-9A-Fa-f]{2})+
        (?:/ (?:[A-Za-z0-9\-._~!$&'()*+,;=:@]|%[0-9A-Fa-f]{2})* )*
    |
    )
    (?:\? (?:[A-Za-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9A-Fa-f]{2})* )?
    `x";
  return preg_match($pattern, $value) === 1;
}

/**
 * Implements hook_field_is_empty().
 */
function edoweb_field_field_is_empty($item, $field) {
  if (empty($item['value']) && (string) $item['value'] !== '0') {
    return TRUE;
  }
  return FALSE;
}

/**
 * Implements hook_field_widget_info().
 *
 * @see field_example_field_widget_form()
 */
function edoweb_field_field_widget_info() {

  return array(
    'edoweb_autocomplete_widget' => array(
      'label' => t('Auto-complete'),
      'field types' => array('edoweb_ld_reference'),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_CUSTOM,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
    'edoweb_upload_widget' => array(
      'label' => t('File Upload'),
      'field types' => array('edoweb_datastream'),
    ),
  );

}

/**
 * Implements hook_field_formatter_info().
 */
function edoweb_field_field_formatter_info() {
  return array(
    'edoweb_ld_format' => array(
      'label' => t('Linked data URI'),
      'field types' => array('edoweb_ld_reference'),
      'multiple values' => FIELD_BEHAVIOR_DEFAULT,
    ),
    'edoweb_datastream_format' => array(
      'label' => t('Datastream URI'),
      'field types' => array('edoweb_datastream'),
      'multiple values' => FIELD_BEHAVIOR_DEFAULT,
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function edoweb_field_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $elements = array();
  switch ($display['type']) {
    case 'edoweb_ld_format':
      $elements = _edoweb_field_embed_entities($items, $entity->remote_id);
      break;
    case 'edoweb_datastream_format':
      $edoweb_api_host = variable_get('edoweb_api_host');
      foreach ($items as $delta => $item) {
        $elements[$delta] = array(
          '#markup' => l($item['value'], "http://$edoweb_api_host/resource/{$item['value']}"),
        );
      }
      break;
  }
  return $elements;
}

function _edoweb_field_embed_entities($items, $referrer = null, $collapsed = 'collapsed') {
  drupal_add_library('system', 'drupal.collapse');
  drupal_add_js(
    drupal_get_path('module', 'edoweb_field') . '/edoweb_field_reference.js'
  );
  $elements = array();
  foreach ($items as $delta => $item) {
    $remote_id = _edoweb_compact_uri($item['value']);
    if (!$remote_id) continue;
    $elements[$delta] = array(
      '#type' => 'fieldset',
      '#attributes' => array(
        'class' => array('collapsible', $collapsed, 'edoweb_ld_reference'),
      ),
      '#title' => $remote_id,
      'entity' => array(
        '#type' => 'hidden',
        '#value' => $remote_id,
      ),
    );
  }
  return $elements;
}

function _edoweb_field_render_embedded_entity(
  $entity, $collapsed = 'collapsed', $as_form = FALSE
) {
  drupal_add_library('system', 'drupal.collapse');
  if ($as_form) {
    $form_state = array();
    $entity_data = array();
    field_attach_form(
      EDOWEB_ENTITY_TYPE, $entity, $entity_data, $form_state
    );
    $entity_data['remote_id'] = array(
      '#type' => 'hidden',
      '#value' => $entity->remote_id,
    );
    $entity_data['bundle_type'] = array(
      '#type' => 'hidden',
      '#value' => $entity->bundle_type,
    );
  } else {
    $entity_data = entity_view(
      EDOWEB_ENTITY_TYPE, array($entity), 'teaser'
    );
  }
  return array(
    '#type' => 'fieldset',
    '#attributes' => array(
      'class' => array('collapsible', $collapsed),
    ),
    '#title' => entity_label(EDOWEB_ENTITY_TYPE, $entity) . " ({$entity->remote_id})",
    'entity' => $entity_data,
  );
}


/**
 * Implements hook_field_widget_form().
 *
 * hook_widget_form() is where Drupal tells us to create form elements for
 * our field's widget.
 *
 */
function edoweb_field_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  switch ($instance['widget']['type']) {
    case 'edoweb_autocomplete_widget':

      // Add autocomplete JS
      drupal_add_library('system', 'ui.autocomplete');
      drupal_add_js(
        drupal_get_path('module', 'edoweb_field') . '/edoweb_field_autocomplete.js'
      );

      // The entity being edited
      $entity = $form['#entity'];

      // Get field configuration
      $field_info = field_info_field($field['field_name']);
      $field_name = $field_info['field_name'];
      $field_cardinality = $field_info['cardinality'];

      $handler_settings = array_key_exists(
        'handler_settings', $field_info['settings']
      ) ? $field_info['settings']['handler_settings']
        : false;

      $embedded_creation = $handler_settings && array_key_exists(
        'embedded_creation', $handler_settings
      ) ? $handler_settings['embedded_creation']
        : false;

      // Submitted search term
      if (array_key_exists('values', $form_state)
          && array_key_exists('edoweb_autocomplete_widget', $form_state['values'])
          && array_key_exists($field_name, $form_state['values']['edoweb_autocomplete_widget'])
      ) {
        $term = $form_state['values']['edoweb_autocomplete_widget'][$field_name]['search'];
      } else {
        $term = '';
      }

      // Widget Fieldset
      $element += array(
        '#type' => 'fieldset',
      );

      // Reload items from form_state values
      if (array_key_exists('values', $form_state)) {
        $items = array();
        if (array_key_exists($field_name, $form_state['values'])) {
          foreach ($form_state['values'][$field_name][LANGUAGE_NONE] as $value) {
            array_push($items, $value);
          }
        }
      }

      $page = 0;
      // Handle button events
      if (array_key_exists('triggering_element', $form_state)) {
        $triggering_element = $form_state['triggering_element']['#name'];
        $split_pos = strrpos($triggering_element, '_');
        $widget_name = substr($triggering_element, 0, $split_pos);
        $index = substr($triggering_element, $split_pos + 1);
        // Handle add event
        if ($widget_name == "edoweb_autocomplete_widget_add_{$field_name}") {
          $element['#prefix'] = '<a name="focus"></a>';
          $added_value =
            $form_state['values']['edoweb_autocomplete_widget'][$field_name]['option'][$index]['value'];
          if ($added_value != '') {
            if ($index === 'embedded' && $embedded_creation) {
              $added_entity = entity_get_controller('edoweb_basic')->create($added_value);
              entity_get_controller('edoweb_basic')->save($added_entity);
              array_unshift($items, array('value' => $added_entity->remote_id));
            } else {
              array_unshift($items, array('value' => $added_value));
            }
          }
          $term = '';
        }
        if ($widget_name == "edoweb_autocomplete_widget_search_{$field_name}_page") {
          $page = (int) $index;
        }
      }

      // Handle remove event - because of the way drupal works, the
      // value needs to be empty but still present in the array, i.e.
      // unset($items[$i]) will not work! This is why we need to track
      // the actual count of set values separately in order to properly
      // handle cardinality limits.
      $value_count = 0;
      foreach (array_keys($items) as $i) {
        if (array_key_exists('triggering_element', $form_state)) {
          if ($form_state['triggering_element']['#name']
              == "edoweb_autocomplete_widget_remove_{$field_name}_{$i}"
          ) {
            $form_state['values'][$field_name][LANGUAGE_NONE][$i]['value'] = '';
            $items[$i]['value'] = '';
            $element['#prefix'] = '<a name="focus"></a>';
          }
        }
        if ($items[$i]['value'] != '') {
          $value_count++;
        }
      }

      // Fieldset for search elements
      $element['edoweb_autocomplete_widget'] = array(
        '#type' => 'fieldset',
        '#title' => t('Hinzufügen'),
        '#parents' => array(
          'edoweb_autocomplete_widget', $field_name
        ),
      );

      // Textfield for search input
      $element['edoweb_autocomplete_widget']['search'] = array(
        '#type' => 'textfield',
        '#default_value' => $term,
        '#parents' => array(
          'edoweb_autocomplete_widget', $field_name, 'search'
        ),
        '#attributes' => array(
          'class' => array(
            'edoweb_autocomplete_widget',
            $field_name,
            $instance['bundle']
          ),
        ),
      );

      // Submit button for search
      $element['edoweb_autocomplete_widget']['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Suchen'),
        '#name' => "edoweb_autocomplete_widget[$field_name][submit]",
        '#parents' => array(
          'edoweb_autocomplete_widget', $field_name, 'submit'
        ),
        '#submit' => array('edoweb_autocomplete_widget_update_value'),
      );

      // Search result listing
      if ($term != '') {
        $matches = array_values(
          _edoweb_lookup($entity->bundle_type, $field_name, $term, $page)
        );
        if ($embedded_creation) {
          $init_val = array();
          $init_val[LANGUAGE_NONE][0]['value'] = $term;
          $embedded_entity = entity_get_controller('edoweb_basic')->create(
            array(
              'bundle_type' => $embedded_creation['bundle'],
              'remote_id' => 'local:' . EdowebBasicController::uuid_v4(),
              $embedded_creation['field'] => $init_val,
            )
          );
          $matches['embedded'] = $embedded_entity;
        }
        foreach ($matches as $i => $match) {
          LinkedDataClient::setTripleStore($match->getSource());
          if ($i === 'embedded') {
            $element['edoweb_autocomplete_widget']['option'][$i]
              = _edoweb_field_render_embedded_entity($match, false, true);
            $element['edoweb_autocomplete_widget']['option'][$i] += array(
              '#description' => t('Wenn die Suche nicht erfolgreich war, kann hier neu erfasst werde.'),
            );
            $element['edoweb_autocomplete_widget']['option'][$i]['entity']['#parents'] = array(
              'edoweb_autocomplete_widget', $field_name, 'option', $i, 'value'
            );
          } else {
            $element['edoweb_autocomplete_widget']['option'][$i]
              = _edoweb_field_render_embedded_entity($match);
            $element['edoweb_autocomplete_widget']['option'][$i]['value'] = array(
              '#type' => 'hidden',
              '#value' => $match->remote_id,
              '#parents' => array(
                'edoweb_autocomplete_widget', $field_name, 'option', $i, 'value'
              ),
            );
          }
          $element['edoweb_autocomplete_widget']['option'][$i]['add'] = array(
            '#type' => 'submit',
            '#name' => "edoweb_autocomplete_widget_add_{$field_name}_{$i}",
            '#value' => t('Hinzufügen'),
            '#submit' => array('edoweb_autocomplete_widget_update_value'),
            '#parents' => array(
              'edoweb_autocomplete_widget', $field_name, 'option', $i, 'add'
            ),
          );
          if (($field_cardinality != FIELD_CARDINALITY_UNLIMITED)
              && ($value_count >= $field_cardinality)
          ) {
            $element['edoweb_autocomplete_widget']['option'][$i]['add']['#disabled'] = TRUE;
          }
        }

        // Paging
        $next_page = (count($matches) < 10) ? FALSE : $page + 1;
        $prev_page = ($page < 1) ? FALSE : $page - 1;

        if ($prev_page === 0 || $prev_page) {
          // Submit button for previous page
          $element['edoweb_autocomplete_widget']['prev_page'] = array(
            '#type' => 'submit',
            '#value' => t('<'),
            '#name' => "edoweb_autocomplete_widget_search_{$field_name}_page_{$prev_page}",
            '#parents' => array(
              'edoweb_autocomplete_widget', $field_name, 'prev_page'
            ),
            '#submit' => array('edoweb_autocomplete_widget_update_value'),
          );
        }
        if ($next_page) {
          // Submit button for next page
          $element['edoweb_autocomplete_widget']['next_page'] = array(
            '#type' => 'submit',
            '#value' => t('>'),
            '#name' => "edoweb_autocomplete_widget_search_{$field_name}_page_{$next_page}",
            '#parents' => array(
              'edoweb_autocomplete_widget', $field_name, 'next_page'
            ),
            '#submit' => array('edoweb_autocomplete_widget_update_value'),
          );
        }
        $element['#prefix'] = '<a name="focus"></a>';
        LinkedDataClient::setTripleStore(null);
      }

      // List items
      $element['data'] = array(
        '#parents' => array(
          'edoweb_autocomplete_widget', $field_name, 'data'
        ),
      );
      $referrer = isset($entity->remote_id) ? $entity->remote_id : null;
      $element['data'] += _edoweb_field_embed_entities(
        $items, $referrer
      );
      foreach (array_keys($items) as $i) {
        // Hidden inputs for values
        $element[$i]['value'] = array(
          '#type' => 'hidden',
          '#value' => $items[$i]['value'],
        );
        if (!edoweb_field_field_is_empty($items[$i], $field)) {
          // Submit button to remove value
          $element['data'][$i]['remove'] = array(
            '#type' => 'submit',
            '#name' => "edoweb_autocomplete_widget_remove_{$field_name}_{$i}",
            '#value' => t('Entfernen'),
            '#submit' => array('edoweb_autocomplete_widget_update_value'),
          );
        }
      }


      break;

    case 'edoweb_upload_widget':
      $widget = $element;
      $widget['#delta'] = $delta;
      $value = isset($items[$delta]['value']) ? $items[$delta]['value'] : '';
      if ($value == '') {
        $widget += array(
          '#type' => 'file',
          '#title' => t('Choose a file'),
        );
      }
      $element['value'] = $widget;
  }

  return $element;
}

function edoweb_autocomplete_widget_update_value($form, &$form_state) {
  unset($form['edoweb_autocomplete_widget']['search']['#value']);
  unset($form_state['input']['edoweb_autocomplete_widget']);
  unset($form_state['edoweb_autocomplete_widget']);
  unset($form_state['complete form']['edoweb_autocomplete_widget']);
  $form_state['rebuild'] = TRUE;
}

/**
 * Add cache table for linked data labels
 */
function edoweb_field_update_7100() {
  $schema = drupal_get_schema('edoweb_ld_reference_label_cache', TRUE);
  db_create_table('edoweb_ld_reference_label_cache', $schema);
}
